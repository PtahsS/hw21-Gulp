"use strict";function _createForOfIteratorHelper(t,e){var o;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(o=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){o&&(t=o);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,a=!1;return{s:function(){o=t[Symbol.iterator]()},n:function(){var t=o.next();return s=t.done,t},e:function(t){a=!0,r=t},f:function(){try{s||null==o.return||o.return()}finally{if(a)throw r}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,n=new Array(e);o<e;o++)n[o]=t[o];return n}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,o){return e&&_defineProperties(t.prototype,e),o&&_defineProperties(t,o),t}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var Model=function(){function t(e,o){_classCallCheck(this,t),_defineProperty(this,"baseUrl",void 0),_defineProperty(this,"userLogin",void 0),_defineProperty(this,"token",void 0),_defineProperty(this,"notes",[]),this.baseUrl=e,this.userLogin=o,this.todos=JSON.parse(localStorage.getItem("todos"))||[]}return _createClass(t,[{key:"auth",value:function(t){var e=this;fetch("".concat(this.baseUrl,"/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:this.userLogin})}).then((function(t){return t.json()})).then((function(o){var n=o.access_token;e.token=n,t()}))}},{key:"init",value:function(t){var e=this;fetch("".concat(this.baseUrl,"/todo"),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.token)}}).then((function(t){return t.json()})).then((function(o){e.notes=o,e.notes.map((function(t){t.value=JSON.parse(t.value)})),console.log("Init is done"),console.log(e.notes),t(e.notes)}))}},{key:"bindTodoListChanged",value:function(t){this.onTodoListChanged=t}},{key:"addTodo",value:function(t){var e=this,o=t.split(", "),n=JSON.stringify({name:o[0],content:o[1]});fetch("".concat(this.baseUrl,"/todo"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.token)},body:JSON.stringify({value:n,priority:1})}).then((function(t){if(!(t.status>=200&&t.status<=210))throw new Error("Error add");return console.log("Added"),t})).then((function(t){return t.json()})).then((function(t){t={_id:t._id,user:t.user,value:JSON.parse(t.value),checked:t.checked,addedAt:t.addedAt},e.notes.push(t),e.onTodoListChanged(e.notes)}))}},{key:"editTodo",value:function(t,e){var o=this,n=e.split(", "),i=JSON.stringify({name:n[0],content:n[1]});fetch("".concat(this.baseUrl,"/todo/").concat(t),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.token)},body:JSON.stringify({value:i,priority:1})}).then((function(t){if(!(t.status>=200&&t.status<=210))throw new Error("Error edit");return console.log("Edited"),t})).then((function(t){return t.json()})).then((function(t){t={_id:t._id,user:t.user,value:JSON.parse(t.value),checked:t.checked,addedAt:t.addedAt},o.notes=o.notes.map((function(e){return e._id===t._id&&(e=t),e})),o.onTodoListChanged(o.notes)}))}},{key:"deleteTodo",value:function(t){var e=this;console.log("model delete"),fetch("".concat(this.baseUrl,"/todo/").concat(t),{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.token)}}).then((function(o){if(!(o.status>=200&&o.status<=210))throw new Error("Error delete");console.log("Deleted"),e.notes=e.notes.filter((function(e){return e._id!=t})),e.onTodoListChanged(e.notes)}))}},{key:"toggleTodo",value:function(t){var e=this;fetch("".concat(this.baseUrl,"/todo/").concat(t,"/toggle"),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.token)}}).then((function(o){if(!(o.status>=200&&o.status<=210))throw new Error("Error toggle");e.notes=e.notes.map((function(e){return e._id==t&&(e.checked=!e.checked),e})),console.log("y",e.notes),e.onTodoListChanged(e.notes)}))}}]),t}(),View=function(){function t(){_classCallCheck(this,t),_defineProperty(this,"showChecked",!0),this.app=this.getElement("#root"),this.form=this.createElement("form"),this.input=this.createElement("input","input-note"),this.input.type="text",this.input.placeholder="Одесса, герой",this.input.id="todo",this.label=this.createElement("label"),this.label.setAttribute("for","todo"),this.label.textContent="Введите название города и его образ через запятую",this.submitButton=this.createElement("button"),this.submitButton.textContent="Добавить",this.toggleNotesButton=this.createElement("button"),this.toggleNotesButton.textContent="Спрятать выделенные",this.toggleNotesButton.id="show-toggled-button",this.form.append(this.label,this.input,this.submitButton,this.toggleNotesButton),this.title=this.createElement("h1"),this.title.textContent="Заметки",this.todoList=this.createElement("ul","todo-list"),this.app.append(this.title,this.form,this.todoList),this._temporaryTodoText=""}return _createClass(t,[{key:"_resetInput",value:function(){this.input.value=""}},{key:"createElement",value:function(t,e){var o=document.createElement(t);return e&&o.classList.add(e),o}},{key:"getElement",value:function(t){return document.querySelector(t)}},{key:"displayTodos",value:function(t){for(var e=this;this.todoList.firstChild;)this.todoList.removeChild(this.todoList.firstChild);if(0===t.length){var o=this.createElement("p");o.textContent="Заметок нет. Добавьте их!",this.todoList.append(o)}else t.forEach((function(t){var o=e.createElement("li");o.dataset.checked=t.checked,o.classList.add("list-item"),o.id=t._id;var n=e.createElement("span","value");if(n.contentEditable=!0,n.classList.add("editable"),t.checked){var i=e.createElement("s");i.textContent="Это ".concat(t.value.name,". Город ").concat(t.value.content),n.append(i)}else n.textContent="Это ".concat(t.value.name,". Город ").concat(t.value.content);var r=e.createElement("button","toggle-button");r.textContent="Выполненные";var s=e.createElement("button","delete");s.textContent="Удалить",s.classList.add("delete-button"),o.append(n,r,s),e.todoList.append(o)}))}},{key:"_initLocalListeners",value:function(){var t=this;this.todoList.addEventListener("input",(function(e){"editable"===e.target.className&&(t._temporaryTodoText=e.target.innerText)}))}},{key:"bindAddTodo",value:function(t){var e=this;this.form.addEventListener("submit",(function(o){o.preventDefault(),e._todoText&&(t(e._todoText),e._resetInput())}))}},{key:"bindShowCheckedNotes",value:function(t){var e=this,o=this.getElement("#show-toggled-button");o.addEventListener("click",(function(){e.showChecked=!e.showChecked,o.innerHTML=e.showChecked?"Спрятать выделенные":"Показать выделенные";var t,n=_createForOfIteratorHelper(document.querySelectorAll("[data-checked]"));try{for(n.s();!(t=n.n()).done;){var i=t.value;"true"!==i.getAttribute("data-checked")||e.showChecked?i.closest(".list-item").classList.remove("hide"):i.closest(".list-item").classList.add("hide")}}catch(t){n.e(t)}finally{n.f()}}))}},{key:"bindDeleteTodo",value:function(t){for(var e=document.querySelectorAll(".delete-button"),o=0;o<e.length;o++)e[o].addEventListener("click",(function(e){e.preventDefault();var o=this.closest(".list-item").id;console.log(o),t(o)}))}},{key:"bindEditTodo",value:function(t){var e=this;this.todoList.addEventListener("focusout",(function(o){if(e._temporaryTodoText){var n=parseInt(o.target.parentElement.id);t(n,e._temporaryTodoText)}}))}},{key:"bindToggleTodo",value:function(t){for(var e=document.querySelectorAll(".toggle-button"),o=0;o<e.length;o++)e[o].addEventListener("click",(function(e){e.preventDefault();var o=this.closest(".list-item").id;console.log(o),t(o)}))}},{key:"_todoText",get:function(){return this.input.value}}]),t}(),Controller=function t(e,o){var n=this;_classCallCheck(this,t),_defineProperty(this,"onInit",(function(){n.model.init(n.onTodoListChanged)})),_defineProperty(this,"onTodoListChanged",(function(t){n.view.displayTodos(t),n.handlers()})),_defineProperty(this,"handlers",(function(){n.view._initLocalListeners(),n.view.bindDeleteTodo(n.handleDeleteTodo),n.view.bindEditTodo(n.handleEditTodo),n.view.bindToggleTodo(n.handleToggleTodo)})),_defineProperty(this,"handleAddTodo",(function(t){n.model.addTodo(t)})),_defineProperty(this,"handleShowCheckedNotes",(function(t){onShowCheckedNotes(t)})),_defineProperty(this,"handleEditTodo",(function(t,e){n.model.editTodo(t,e)})),_defineProperty(this,"handleDeleteTodo",(function(t){n.model.deleteTodo(t)})),_defineProperty(this,"handleToggleTodo",(function(t){n.model.toggleTodo(t)})),this.model=e,this.view=o,this.model.bindTodoListChanged(this.onTodoListChanged),this.view.bindAddTodo(this.handleAddTodo),this.view.bindShowCheckedNotes(this.handleShowCheckedNotes),this.model.auth(this.onInit)},app=new Controller(new Model("https://todo.hillel.it","ptahs"),new View);